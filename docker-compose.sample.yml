services:
  db:
    build:
      context: ./database
    restart: always
    ports:
      - 5432:5432
    networks:
      - apidbmgr
    environment:
      POSTGRES_USER: <usuario>
      POSTGRES_PASSWORD: <senha>
      POSTGRES_DB: <bancodados>
      TZ: America/Sao_Paulo
      PGDATA: /var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - ./database/postgres:/var/lib/postgresql/data
      - ./database/postgresql.conf:/var/lib/postgresql/pgdata/postgresql.conf
      - ./database/csv:/tmp/csv
      - ./backups:/backups
  migration:
    build:
      context: .
      dockerfile: Dockerfile.migration
    networks:
      - proxy
      - apidbmgr
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./.env:/app/.env
  api:
    image: waiwai-backend:latest
    restart: always
    depends_on:
      - migration
    volumes:
      - ./.env:/app/.env
      - ./backend/static:/app/backend/static
    networks:
      - proxy
      - apidbmgr
  proxy:
    build:
      context: ./nginx
    ports:
      - 80:80
      - 443:443
    volumes:
        - ./nginx/nginx.conf:/etc/nginx/nginx.conf
        - ./nginx/conf.d:/etc/nginx/conf.d
        - ./nginx/letsencrypt:/etc/letsencrypt
    networks:
      - proxy
    depends_on:
      - api
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 20M
      restart_policy:
        condition: on-failure

networks:
  proxy:
    name: api_proxy
    external: true
  apidbmgr:
    name: api_db_migration
    external: true